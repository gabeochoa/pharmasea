#include "system_manager.h"
#include "afterhours_systems.h"
#include "../components/can_hold_item.h"
#include "../components/is_item_container.h"

// Individual system headers for gamelike systems
#include "end_of_round_completion_validation_system.h"
#include "pass_time_for_transaction_animation_system.h"
#include "process_ai_system.h"
#include "process_pnumatic_pipe_pairing_system.h"
#include "run_timer_system.h"

namespace system_manager {

// System for processing containers that should backfill items during gamelike
// updates
struct ProcessIsContainerAndShouldBackfillItemSystem
    : public afterhours::System<IsItemContainer, CanHoldItem> {
    virtual ~ProcessIsContainerAndShouldBackfillItemSystem() = default;

    virtual bool should_run(const float) override {
        if (!GameState::get().is_game_like()) return false;
        try {
            Entity& sophie = EntityHelper::getNamedEntity(NamedEntity::Sophie);
            const HasDayNightTimer& timer = sophie.get<HasDayNightTimer>();
            // Skip during transitions to avoid creating hundreds of items
            // before transition logic completes
            return !timer.needs_to_process_change;
        } catch (...) {
            return true;
        }
    }

    // TODO fold in function implementation
    virtual void for_each_with(Entity& entity, IsItemContainer& iic,
                               CanHoldItem& canHold, float dt) override {
        (void) iic;      // Unused parameter
        (void) canHold;  // Unused parameter
        system_manager::process_is_container_and_should_backfill_item(entity, dt);
    }
};

}  // namespace system_manager

// Forward declaration for system defined in system_manager namespace
namespace system_manager {
struct ProcessIsContainerAndShouldBackfillItemSystem;
}

void SystemManager::register_gamelike_systems() {
    systems.register_update_system(
        std::make_unique<system_manager::RunTimerSystem>());
    systems.register_update_system(
        std::make_unique<system_manager::ProcessPnumaticPipePairingSystem>());
    systems.register_update_system(
        std::make_unique<
            system_manager::ProcessIsContainerAndShouldBackfillItemSystem>());
    systems.register_update_system(
        std::make_unique<
            system_manager::PassTimeForTransactionAnimationSystem>());
    systems.register_update_system(
        std::make_unique<system_manager::ProcessAiSystem>());
    systems.register_update_system(
        std::make_unique<
            system_manager::EndOfRoundCompletionValidationSystem>());

    register_day_night_transition_systems();
}
