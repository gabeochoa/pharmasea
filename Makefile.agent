## Minimal Linux Makefile (agent-generated)
##
## Goal:
## - Prove the codebase (and recent changes) compile on this Linux image.
## - Do NOT depend on macOS/Windows-only prebuilt libs in vendor/.
##
## Notes:
## - This environment does not have a Linux raylib or GameNetworkingSockets .so,
##   so the final link step may fail. We still build all translation units to .o.
##
## Usage:
##   make -f Makefile.agent -j 4 objects     # compile all .o files
##   make -f Makefile.agent -j 4             # tries link too (may fail)
##   make -f Makefile.agent clean

.PHONY: all objects clean print-config

UNAME_S := $(shell uname -s)

# Prefer clang++ because the codebase (and afterhours) is primarily authored
# against clang. Force it (GNU make defaults CXX=g++).
CXX := clang++

OUT_DIR := output_agent
BIN := pharmasea_linux

# Precompiled header (mirrors repo makefile behavior; required because some
# code assumes common headers (e.g. <cassert>) are provided via the PCH.
PCH_HEADER := src/pch.hpp
PCH_GCH := src/pch.hpp.gch

# Project includes (IMPORTANT: -iquote src avoids collision with libc's <strings.h>)
INCLUDES := -Ivendor -Ivendor/ -Ivendor/raylib -iquote src

# Core flags
CXXFLAGS := -std=c++2a -g -O0 -DTRACY_ENABLE \
	-Wall -Wextra -Wshadow -Wno-pedantic -Wno-conversion -Wno-sign-conversion \
	-Wno-missing-field-initializers -Wno-deprecated-volatile -Wno-unused-function \
	$(INCLUDES)

# Sources (match repo's main makefile intent)
SRC_FILES := $(wildcard src/*.cpp src/**/*.cpp src/engine/**/*.cpp src/network/**/*.cpp)
OBJ_FILES := $(patsubst %.cpp,$(OUT_DIR)/%.o,$(SRC_FILES))
DEP_FILES := $(OBJ_FILES:.o=.d)

all: objects $(BIN)

print-config:
	@echo "CXX=$(CXX)"
	@echo "UNAME_S=$(UNAME_S)"
	@echo "SRC_FILES=$(words $(SRC_FILES))"

objects: $(PCH_GCH) $(OBJ_FILES)

# Compile rule
$(OUT_DIR)/%.o: %.cpp Makefile.agent $(PCH_GCH)
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) -include $(PCH_HEADER) -MMD -MP -c $< -o $@

# Build the precompiled header (.gch) next to the header, so clang automatically
# uses it when we pass `-include src/pch.hpp`.
$(PCH_GCH): $(PCH_HEADER) Makefile.agent
	$(CXX) $(CXXFLAGS) -x c++-header -o $(PCH_GCH) $(PCH_HEADER)

# Link rule (best-effort)
# This will probably fail until Linux raylib + GameNetworkingSockets are provided.
$(BIN): $(OBJ_FILES)
	@echo "Attempting link (may fail without Linux raylib/GNS libs)..."
	$(CXX) $(CXXFLAGS) $(OBJ_FILES) -o $@ \
		-lraylib -lGameNetworkingSockets -lGL -lm -lpthread -ldl -lrt -lX11 || \
		( echo ""; \
		  echo "Link failed (expected in this environment)."; \
		  echo "To link on Linux you need raylib + GameNetworkingSockets .so (or static libs)."; \
		  echo "You can still validate compilation via: make -f Makefile.agent objects"; \
		  false )

clean:
	rm -rf $(OUT_DIR) $(BIN) $(PCH_GCH)

-include $(DEP_FILES)

